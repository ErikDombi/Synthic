@using Synthic.Helpers

<div class="tracks-page">
    <div class="left-sidebar">
        @foreach (var track in Editor.Album.Tracks)
        {
            <div class="entry" @onclick="(() => LoadTrack(track))">@track.Name</div>
        }
    </div>
    <div class="subpage-content">
        <div class="metadata">
            <MetadataInput Property="ActiveTrack.Metadata.Title" Title="Title" Callback="(x) => ActiveTrack.Metadata.Title = x"/>
            <MetadataInput Property="ActiveTrack.Metadata.Artist" Title="Artist" Callback="(x) => ActiveTrack.Metadata.Artist = x"/>
            <MetadataInput Property="ActiveTrack.Metadata.Composer" Title="Composer" Callback="(x) => ActiveTrack.Metadata.Composer = x"/>
            <MetadataInput Property="ActiveTrack.Metadata.Year" Title="Year" Callback="(x) => ActiveTrack.Metadata.Year = x"/>
            <MetadataInput Property="ActiveTrack.Metadata.Track" Title="Track" Callback="(x) => ActiveTrack.Metadata.Track = x"/>
            <MetadataInput Property="ActiveTrack.Metadata.Genre" Title="Genre" Callback="(x) => ActiveTrack.Metadata.Genre = x"/>
            @foreach (var metadata in ActiveTrack.Metadata.CustomMetadata)
            {
                <MetadataInput
                    Property="metadata.Value"
                    Title="@metadata.Key"
                    Callback="(x) => ActiveTrack.Metadata.CustomMetadata[metadata.Key] = x"
                    Custom="true"
                    OnDelete="() => { ActiveTrack.Metadata.CustomMetadata.Remove(metadata.Key); StateHasChanged(); }"/>
            }
            <div class="add-metadata-btn">
                <input class="absolute custom-metadata-name" @bind="NewFieldName" placeholder="Field Name"/>
                <button class="absolute custom-metadata-add @StageClass" @onclick="NextStage">@StageString</button>
            </div>
        </div>
    </div>
</div>

@code {
    [Inject]
    private EditorInstance Editor { get; set; }

    private string StageString = "Add Custom Field";
    private string StageClass = "fill";
    private string NewFieldName = "";
    
    private void NextStage()
    {
        switch (StageClass)
        {
            case "fill":
                StageClass = "right";
                StageString = "Add";
                break;
            case "right":
                StageClass = "fill";
                StageString = "Add Custom Field";
                if(!string.IsNullOrWhiteSpace(NewFieldName) && !ActiveTrack.BuildMetadata(Editor.Album).Keys.Select(x => x.ToLower()).Contains(NewFieldName.ToLower()))
                    ActiveTrack.Metadata.CustomMetadata.Add(NewFieldName, "");
                NewFieldName = "";
                break;
        }
    }
    
    
    private Track ActiveTrack;

    protected override void OnParametersSet()
    {
        ActiveTrack = Editor.Album.Tracks.First();
    }
    
    private void LoadTrack(Track track)
    {
        ActiveTrack = track;
    }
}